{% extends 'layout.html' %}
{% block title %}
  {% if not data.ok %}Error Happened{% elif data.query %}Search for "{{ data.query }}"{% else %}Products{% endif %}
{% endblock %}
{% block content %}

<div class="py-5 bg-body-tertiary">
  <div class="container">
    {% if not data.ok %}
      <div class="alert alert-danger p-4 text-center">
        <h4 class="mb-3">‚ö†Ô∏è Unable to load products</h4>
        <p class="text-muted">Shopify returned an error. You can try again or contact support if this persists.</p>

        {% if data.errors %}
          <pre class="text-start bg-light p-3 border rounded small text-danger" style="white-space: pre-wrap;">{{ data.errors | tojson(indent=2) }}</pre>
        {% endif %}

        <form method="GET" class="d-inline-block mt-3">
          <input type="hidden" name="q" value="{{ data.query }}">
          <input type="hidden" name="limit" value="{{ data.limit }}">
          {% if data.show_incompleted %}
            <input type="hidden" name="showIncompleted" value="1">
          {% endif %}
          <button type="submit" class="btn btn-danger">üîÅ Retry</button>
        </form>
      </div>
    {% else %}
      <!-- Search Form -->
      <form method="GET" action="{{ url_for('main.products') }}" style="max-width: 650px;" class="m-auto mb-5">
        <label for="search" class="form-label">Search</label>
        <div class="input-group">
          <!-- Store selector -->
          <select name="store" id="store" class="form-select" style="flex: none; width: 150px;" onchange="this.form.submit()">
            <option value="shop1" {% if data.current_store_key == 'shop1' %}selected{% endif %}>US Store</option>
            <option value="shop2" {% if data.current_store_key == 'shop2' %}selected{% endif %}>Canada Store</option>
          </select>
          <input
            type="search"
            class="form-control"
            id="search"
            name="q"
            placeholder="Product Name"
            value="{{ data.query }}"
          />
          <input type="hidden" name="limit" value="{{ data.limit }}">
          <button class="btn btn-primary" type="submit">Search</button>
        </div>
      </form>
  
      <div class="d-flex justify-content-between my-5">
        <div>
          <p>
            <strong>{{ data.start }}</strong> ‚Äì <strong>{{ data.end }}</strong> of <strong>{{ data.total_count }}</strong>
            {% if data.query %}
              <br><small>Search: <i>"{{ data.query }}"</i></small>
            {% endif %}
          </p>
          <p><small>Items on this page: <strong>{{ data.current_page_showing }}</strong></small></p>
        </div>

        <div class="text-end">
          <p>Page <strong>{{ data.current_page }}</strong> / <strong>{{ data.total_pages }}</strong></p>
        </div>
      </div>
      
      <div class="d-flex flex-wrap justify-content-between align-items-center my-5">
        <!-- Filter -->
        <form method="GET" class="d-flex gap-3 align-items-center">
          <input type="hidden" name="q" value="{{ data.query }}">
          <input type="hidden" name="store" value="{{ data.current_store_key }}">
          <label for="limit" class="form-label">Show:</label>
          <select id="limit" name="limit" class="form-select" style="width: 100px;" onchange="this.form.submit()">
            {% for option in [5, 20, 40, 50, 70, 100] %}
              <option value="{{ option }}" {% if data.limit == option %}selected{% endif %}>{{ option }}</option>
            {% endfor %}
          </select>
  
          <!-- Checkbox filter -->
          <div class="form-check form-switch">
            <input
              class="form-check-input"
              type="checkbox"
              role="switch"
              id="showIncompleted"
              name="showIncompleted"
              value="1"
              {% if data.show_incompleted %}checked{% endif %}
              onchange="this.form.submit()"
            />
            <label class="form-check-label" for="showIncompleted">Show Incompleted</label>
          </div>
        </form>
  
        <div>
          <button type="button" id="perform_all" class="btn btn-outline-success">Perform to all</button>
        </div>
      </div>
      
  
      <!-- Products List -->
      <div {% if data.products %}{% else %}style="min-height: 40vh;"{% endif %} class="{% if data.products %}row-cols-sm-2 row-cols-md-3{% else %}justify-content-center align-items-center row-cols-sm-1 row-cols-md-1{% endif %} row row-cols-1 g-3">
        {% if data.products %}
          {% for product in data.products %}
            <div class="col">

              <div class="card shadow-sm h-100">
                <!-- Product Image -->
                <img src="{{ product.featured_image }}&width=350&height=225&crop=center" 
                class="bd-placeholder-img card-img-top" 
                alt="{{ product.title }}" 
                height="225" 
                style="object-fit: cover;" />
                
                <div class="card-body" data-current-store-key="{{ data.current_store_key }}">
                  <!-- Title -->
                  <span class="badge bg-secondary ">{{ product.store_name }}</span>
                  <a href="{{ product.preview_url }}" target="_blank" class="text-decoration-none">
                    <h5 class="card-title text-truncate" title="{{ product.title }}">{{ product.title }}</h5>
                  </a>

                  <!-- Info List -->
                  <ul class="list-unstyled small mb-3">
                    <li><strong>Variants:</strong> {{ product.variant_count }}</li>
                    <li><strong>Product Images:</strong> {{ product.media_count }}</li>
                    <li><strong>Variant Images:</strong> {{ product.total_variant_images_count }}</li>
                    <li class="is_filled"><strong>Images Filled:</strong> {{ "‚úÖ Yes" if product.is_filled_images else "‚ùå No" }}</li>
                    {% if product.has_errors %}
                      <div class="alert errors alert-danger mt-2">
                        <strong>Errors:</strong>
                        <ol class="mb-0">
                          {% for error in product.errors %}
                            <li>{{ error }}</li>
                          {% endfor %}
                        </ol>
                      </div>
                    {% endif %}
                  </ul>

                  <div class="result"></div>

                  <!-- Buttons -->
                  <div class="mt-auto">
                    <button class="{% if product.is_filled_images %}d-none{% else %}d-block{% endif %} btn btn-outline-primary w-100 mb-2" data-populate-button data-product-id="{{ product.id }}">
                      Populate Images
                    </button>
                    <button class="{% if product.is_filled_images %}d-block{% else %}d-none{% endif %} btn btn-outline-danger w-100" data-populate-button-delete data-product-id="{{ product.id }}">
                      Delete Asset Images
                    </button>
                  </div>
                </div>
              </div>

            </div>
          {% endfor %}
        {% else %}
          <p class="text-center">No products found.</p>
        {% endif %}
      </div>
  
      <!-- Pagination Controls -->
      <nav aria-label="Product pagination" class="my-5">
        <ul class="pagination justify-content-center">
  
        {% if data.has_previous_page and data.start_cursor %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('main.products', limit=data.limit, before=data.start_cursor, start=data.start-data.limit, q=data.query, showIncompleted=data.show_incompleted, store=data.current_store_key) }}">Previous Page</a>
          </li>
        {% endif %}
        {% if data.has_next_page and data.end_cursor %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('main.products', limit=data.limit, after=data.end_cursor, start=data.end+1, q=data.query, showIncompleted=data.show_incompleted, store=data.current_store_key) }}">Next Page</a>
          </li>
        {% endif %}
          
        </ul>
      </nav>
    {% endif %}


  </div>
</div>

{% endblock %}
