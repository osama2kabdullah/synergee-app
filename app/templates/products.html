{% set limit_options = [] %}
{% for n in [5, 20, 40, 50, 70, 100] %}
  {% set _ = limit_options.append({'value': n|string, 'label': n|string}) %}
{% endfor %}

{% set filters = [
    { 'name': 'q', 'type': 'text', 'value': data.query, 'placeholder': 'Product Name' },
    { 'name': 'store', 'type': 'select', 'value': data.current_store_key, 
      'options': [{'value': 'shop1', 'label': 'US Store'}, {'value': 'shop2', 'label': 'Canada Store'}]
    },
    { 'name': 'limit', 'type': 'select', 'value': data.limit|string, 'options': limit_options },
    { 'name': 'showIncompleted', 'type': 'checkbox', 'value': '1', 'checked': data.show_incompleted, 'label': 'Show Incompleted' }
] %}

{% extends 'layout.html' %}
{% block title %}
  {% if not data.ok %}Error Happened{% elif data.query %}Search for "{{ data.query }}"{% else %}Products{% endif %}
{% endblock %}

{% block content %}
<div class="py-5 bg-body-tertiary">
  <div class="container">
    
    {% if not data.ok %}
      <!-- Error Section -->
      <div class="alert alert-danger p-4 text-center">
        <h4 class="mb-3">‚ö†Ô∏è Unable to load products</h4>
        <p class="text-muted">Shopify returned an error. You can try again or contact support if this persists.</p>

        {% if data.errors %}
          <pre class="text-start bg-light p-3 border rounded small text-danger" style="white-space: pre-wrap;">{{ data.errors | tojson(indent=2) }}</pre>
        {% endif %}

        <form method="GET" class="d-inline-block mt-3">
          {% for f in filters %}
            {% if f.type != 'checkbox' or f.checked %}
              <input type="hidden" name="{{ f.name }}" value="{{ f.value }}">
            {% endif %}
          {% endfor %}
          <button type="submit" class="btn btn-danger">üîÅ Retry</button>
        </form>
      </div>

    {% else %}
      <!-- Search & Filters Form -->
      <form method="GET" action="{{ url_for('main.products') }}" class="m-auto mb-5 d-flex gap-2 flex-wrap align-items-center">
        {% for f in filters %}
          {% if f.type == 'text' %}
            <input type="text" name="{{ f.name }}" value="{{ f.value }}" placeholder="{{ f.placeholder }}" class="form-control">
          {% elif f.type == 'select' %}
            <select name="{{ f.name }}" class="form-select" style="width: {{ f.width|default('auto') }};" onchange="this.form.submit()">
              {% for opt in f.options %}
                <option value="{{ opt.value }}" {% if f.value|string == opt.value|string %}selected{% endif %}>{{ opt.label }}</option>
              {% endfor %}
            </select>
          {% elif f.type == 'checkbox' %}
            <div class="form-check form-switch">
              <input id="{{ f.name }}" class="form-check-input" type="checkbox" name="{{ f.name }}" value="{{ f.value }}" {% if f.checked %}checked{% endif %} onchange="this.form.submit()">
              <label for="{{ f.name }}" class="form-check-label">{{ f.label|default(f.name) }}</label>
            </div>
          {% endif %}
        {% endfor %}
        <button type="submit" class="btn btn-primary">Search</button>
      </form>

      <!-- Pagination & Products -->
      {% set filter_params = {} %}
      {% for f in filters %}
        {% if f.type == 'checkbox' %}
          {% if f.checked %}
            {% set _ = filter_params.update({f.name: f.value}) %}
          {% endif %}
        {% else %}
          {% set _ = filter_params.update({f.name: f.value}) %}
        {% endif %}
      {% endfor %}

      <div class="d-flex justify-content-between my-4">
        <div>
          <p>
            <strong>{{ data.start }}</strong> ‚Äì <strong>{{ data.end }}</strong> of <strong>{{ data.total_count }}</strong>
            {% if data.query %}<br><small>Search: <i>"{{ data.query }}"</i></small>{% endif %}
          </p>
          <p><small>Items on this page: <strong>{{ data.current_page_showing }}</strong></small></p>
        </div>
        <div class="text-end">
          <p>Page <strong>{{ data.current_page }}</strong> / <strong>{{ data.total_pages }}</strong></p>
        </div>
      </div>

      <div class="row {% if data.products %}row-cols-1 row-cols-sm-2 row-cols-md-3{% endif %} g-3" {% if not data.products %}style="min-height: 40vh;"{% endif %}>
        {% if data.products %}
          {% for product in data.products %}
            <div class="col">
              <div class="card shadow-sm h-100">
                <img src="{{ product.featured_image }}&width=350&height=225&crop=center" class="bd-placeholder-img card-img-top" alt="{{ product.title }}" height="225" style="object-fit: cover;">
                <div class="card-body" data-current-store-key="{{ data.current_store_key }}">
                  <span class="badge bg-secondary">{{ product.store_name }}</span>
                  <a href="{{ product.preview_url }}" target="_blank" class="text-decoration-none">
                    <h5 class="card-title text-truncate" title="{{ product.title }}">{{ product.title }}</h5>
                  </a>
                  <ul class="list-unstyled small mb-3">
                    <li><strong>Variants:</strong> {{ product.variant_count }}</li>
                    <li><strong>Product Images:</strong> {{ product.media_count }}</li>
                    <li><strong>Variant Images:</strong> {{ product.total_variant_images_count }}</li>
                    <li class="is_filled"><strong>Images Filled:</strong> {{ "‚úÖ Yes" if product.is_filled_images else "‚ùå No" }}</li>
                  </ul>
                  <div class="result"></div>
                  <div class="errors alert alert-danger {% if product.has_errors %}d-block{% else %}d-none{% endif %} mt-2">
                    {% if product.has_errors %}
                      <strong>Errors:</strong>
                      <ol class="mb-0">
                        {% for error in product.errors %}
                          <li>{{ error }}</li>
                        {% endfor %}
                      </ol>
                    {% endif %}
                  </div>
                  <div class="mt-auto">
                    <button class="btn btn-outline-primary w-100 mb-2 {% if product.is_filled_images %}d-none{% endif %}" data-populate-button data-product-id="{{ product.id }}">Populate Images</button>
                    <button class="btn btn-outline-danger w-100 {% if not product.is_filled_images %}d-none{% endif %}" data-populate-button-delete data-product-id="{{ product.id }}">Delete Asset Images</button>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <p class="text-center">No products found.</p>
        {% endif %}
      </div>

      <!-- Pagination Controls -->
      <nav aria-label="Product pagination" class="my-5">
        <ul class="pagination justify-content-center">
          
          {% if data.has_previous_page and data.start_cursor %}
            <li class="page-item">
              <a class="page-link"
                href="{{ url_for('main.products', q=data.query, store=data.current_store_key, limit=data.limit, showIncompleted='1' if data.show_incompleted else None, before=data.start_cursor, start=data.start - data.limit) }}">
                Previous Page
              </a>
            </li>
          {% endif %}

          {% if data.has_next_page and data.end_cursor %}
            <li class="page-item">
              <a class="page-link"
                href="{{ url_for('main.products', q=data.query, store=data.current_store_key, limit=data.limit, showIncompleted='1' if data.show_incompleted else None, after=data.end_cursor, start=data.end + 1) }}">
                Next Page
              </a>
            </li>
          {% endif %}

        </ul>
      </nav>
    {% endif %}
  </div>
</div>
{% endblock %}
